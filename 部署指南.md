# 部署指南

## 1. 准备
- 将 PatreonOJ 与 PatreonOJ-UI 两个项目 clone 到本地。

## 2. 部署前端（PatreonOJ-UI）
1. 进入 PatreonOJ-UI 目录，执行构建命令：

```bash
npm install
npm run build
```

> 构建生成的静态文件位于 PatreonOJ-UI/dist 目录。

2. 安装 Caddy

参考：<https://caddyserver.com/docs/install#debian-ubuntu-raspbian>

```bash
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
chmod o+r /usr/share/keyrings/caddy-stable-archive-keyring.gpg
chmod o+r /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
```

3. 在与项目同级目录创建 Caddyfile （名字叫这个没有后缀），内容如下：

```
example.com {
	encode gzip zstd

	route {
		# 1) API 一定要先走反代（并去掉 /api 前缀，保持和 Vite 开发代理一致）
		handle_path /api/* {
			reverse_proxy 127.0.0.1:8080
		}

		# 2) 其余都当作前端静态 + SPA（不存在的文件回退到 index.html）
		root * /var/www/PatreonOJ-UI/dist
		try_files {path} /index.html
		file_server
	}
}
```

- 将 example.com 替换为你自己的域名。
- 将 /var/www/PatreonOJ-UI/dist 替换为你机器上实际的 dist 路径。

4. 启动 Caddy （在Caddyfile所在目录）

```bash
caddy adapt
caddy start
```

> caddy run 会以前台方式启动。

## 3. 部署后端（PatreonOJ）
后端依赖：关系型数据库（MySQL/SQLite）、图数据库 Neo4j、对象存储（MinIO）。下面以 Docker 启动为例（示例密码请按需修改，并同步更新 config.yaml）。

1. 启动 MySQL

```bash
docker run -d --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:8.0
```

在配置文件中修改对应连接信息，具体看 config.yaml 中的注释。

2. 启动 Neo4j

```bash
docker run -d --name neo4j -p 7474:7474 -p 7687:7687 -e NEO4J_AUTH=neo4j/123456 neo4j:4.4.1
```

在配置文件中修改对应连接信息，具体看 config.yaml 中的注释。

3. 启动 MinIO

```bash
docker run -d --name minio -p 9000:9000 -p 9001:9001 -e MINIO_ROOT_USER=minioadmin -e MINIO_ROOT_PASSWORD=minioadmin minio/minio server /data --console-address ":9001"
```

> 端口号在配置中填写 9000。

4. 启动 PatreonOJ

在项目目录下执行：

```bash
go run ./cmd/PatreonOJ/main.go
```